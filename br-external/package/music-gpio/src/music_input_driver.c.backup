#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/fs.h>
#include <linux/cdev.h>
#include <linux/device.h>
#include <linux/gpio/consumer.h>
#include <linux/interrupt.h>
#include <linux/gpio.h>
#include <linux/uaccess.h>

#define DRV_NAME "music_input"

static dev_t devno;
static struct cdev mid_cdev;
static struct class *mid_class;
static struct device *mid_dev;

static struct gpio_desc *btn_gpiod;
static int btn_irq = -1;

/* ---------------------------------------------------------------------- */
/* ISR – simple interrupt handler                                         */
/* ---------------------------------------------------------------------- */
static irqreturn_t mid_isr(int irq, void *data)
{
    pr_info("%s: Button interrupt occurred\n", DRV_NAME);
    return IRQ_HANDLED;
}

/* ---------------------------------------------------------------------- */
/* File operations                                                        */
/* ---------------------------------------------------------------------- */

static ssize_t mid_read(struct file *f, char __user *buf, size_t len, loff_t *off)
{
    char msg[] = "button-read\n";
    return simple_read_from_buffer(buf, len, off, msg, sizeof(msg));
}

static int mid_open(struct inode *inode, struct file *f)
{
    return 0;
}

static int mid_release(struct inode *inode, struct file *f)
{
    return 0;
}

static const struct file_operations mid_fops = {
    .owner = THIS_MODULE,
    .open = mid_open,
    .release = mid_release,
    .read = mid_read,
};

/* ---------------------------------------------------------------------- */
/* Init                                                                   */
/* ---------------------------------------------------------------------- */

static int __init mid_init(void)
{
    int ret;

    /* Allocate char device */
    ret = alloc_chrdev_region(&devno, 0, 1, DRV_NAME);
    if (ret)
        return ret;

    /* Setup cdev */
    cdev_init(&mid_cdev, &mid_fops);
    ret = cdev_add(&mid_cdev, devno, 1);
    if (ret)
        goto err_cdev;

    /* Create /sys/class/music_input */
    mid_class = class_create(DRV_NAME);
    if (IS_ERR(mid_class)) {
        pr_err("class_create failed\n");
        ret = PTR_ERR(mid_class);
        goto err_class;
    }

    /* Create /dev/music_input */
    mid_dev = device_create(mid_class, NULL, devno, NULL, DRV_NAME);
    if (IS_ERR(mid_dev)) {
        ret = PTR_ERR(mid_dev);
        goto err_dev;
    }

    /* Get GPIO using device tree label btn-gpios */
    btn_gpiod = gpiod_get(mid_dev, "btn", GPIOD_IN);
    if (IS_ERR(btn_gpiod)) {
        pr_err("%s: gpiod_get failed\n", DRV_NAME);
        ret = PTR_ERR(btn_gpiod);
        goto err_gpio;
    }

    /* Convert GPIO → IRQ */
    btn_irq = gpiod_to_irq(btn_gpiod);
    if (btn_irq < 0) {
        pr_err("%s: gpiod_to_irq failed\n", DRV_NAME);
        ret = btn_irq;
        goto err_irqmap;
    }

    /* Request falling-edge interrupt */
    ret = request_irq(btn_irq, mid_isr,
                      IRQF_TRIGGER_FALLING,
                      DRV_NAME, NULL);
    if (ret) {
        pr_err("request_irq failed\n");
        goto err_irqreq;
    }

    pr_info("%s: driver loaded\n", DRV_NAME);
    return 0;

/* Cleanup handlers */
err_irqreq:
err_irqmap:
    gpiod_put(btn_gpiod);
err_gpio:
    device_destroy(mid_class, devno);
err_dev:
    class_destroy(mid_class);
err_class:
    cdev_del(&mid_cdev);
err_cdev:
    unregister_chrdev_region(devno, 1);
    return ret;
}

/* ---------------------------------------------------------------------- */
/* Exit                                                                   */
/* ---------------------------------------------------------------------- */

static void __exit mid_exit(void)
{
    free_irq(btn_irq, NULL);
    gpiod_put(btn_gpiod);
    device_destroy(mid_class, devno);
    class_destroy(mid_class);
    cdev_del(&mid_cdev);
    unregister_chrdev_region(devno, 1);

    pr_info("%s: driver unloaded\n", DRV_NAME);
}

module_init(mid_init);
module_exit(mid_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Prudhvi");
MODULE_DESCRIPTION("Music button input driver");
